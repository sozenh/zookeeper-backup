# zkbackup - ZooKeeper Backup and Restore Tool

[![Go Version](https://img.shields.io/badge/go-1.21+-blue.svg)](https://golang.org)
[![License](https://img.shields.io/badge/license-Apache%202.0-green.svg)](LICENSE)

zkbackup is a standalone tool focused on ZooKeeper data backup and restore, providing reliable, consistent, and easy-to-use backup solutions.

## Features

- ✅ **Complete Backup**: Backup all snapshot and txnlog files
- ✅ **Reliable Restore**: Automatic validation and repair of corrupted txnlogs
- ✅ **Data Integrity**: Guarantee backup data integrity without transaction loss
- ✅ **Easy Integration**: Clean CLI interface for easy integration with other systems
- ✅ **Universal Compatibility**: Support all ZooKeeper versions (3.4.x ~ 3.9.x)

## Installation

### Build from Source

```bash
git clone https://github.com/sozenh/zookeeper-backup.git
cd zkbackup
make build
sudo mv zkbackup /usr/local/bin/
```

### Download Binary

Download the binary for your platform from the [Releases](https://github.com/yourusername/zkbackup/releases) page.

### Docker

```bash
docker pull registry.example.com/zkbackup:latest
```

## Quick Start

### Backup

```bash
zkbackup backup \
  --zk-data-dir /zookeeper/data/version-2 \
  --zk-log-dir /zookeeper/datalog/version-2 \
  --output-dir /backup/zookeeper \
  --zk-host localhost:2181
```

### Restore

```bash
zkbackup restore \
  --backup-dir /backup/zookeeper/backup-20250115-103000 \
  --zk-data-dir /zookeeper/data/version-2 \
  --zk-log-dir /zookeeper/datalog/version-2
```

### Verify Backup

```bash
zkbackup verify --backup-dir /backup/zookeeper/backup-20250115-103000
```

### List All Backups

```bash
zkbackup list --backup-base-dir /backup/zookeeper
```

### Show Backup Details

```bash
zkbackup info backup-20250115-103000 --backup-base-dir /backup/zookeeper
```

### Clean Old Backups

```bash
zkbackup prune --keep-days 7 --keep-min-count 3
```

## Command Details

### backup - Backup Command

Complete backup of ZooKeeper data.

```bash
zkbackup backup [flags]

Flags:
  --zk-data-dir string      ZooKeeper dataDir path (required)
  --zk-log-dir string       ZooKeeper dataLogDir path (required)
  --output-dir string       Backup output directory (required)
  --zk-host string          ZooKeeper host address (default: localhost:2181)
  --backup-id string        Backup ID (optional, auto-generated by default)
  --verify                  Verify immediately after backup (default: true)
  --compression string      Compression method: none|gzip|zstd (default: gzip)
  --verbose                 Verbose output
```

### restore - Restore Command

Restore ZooKeeper data from backup.

```bash
zkbackup restore [flags]

Flags:
  --backup-dir string       Backup directory path (required)
  --zk-data-dir string      ZooKeeper dataDir path (required)
  --zk-log-dir string       ZooKeeper dataLogDir path (required)
  --force                   Force restore without confirmation (dangerous)
  --dry-run                 Simulate restore without actual execution
  --skip-verify             Skip verification before restore (not recommended)
  --truncate-to-zxid string Restore to specified ZXID (optional)
  --verbose                 Verbose output
```

### verify - Verify Command

Verify backup integrity.

```bash
zkbackup verify [flags]

Flags:
  --backup-dir string       Backup directory path (required)
  --fix                     Automatically repair corrupted files
  --output-format string    Output format: text|json (default: text)
  --verbose                 Verbose output
```

### list - List Command

List all backups.

```bash
zkbackup list [flags]

Flags:
  --backup-base-dir string  Backup base directory (default: /backup/zookeeper)
  --format string           Output format: table|json|simple (default: table)
  --sort-by string          Sort by: time|size|zxid (default: time)
  --limit int               Limit display count (default: 20)
```

### info - Info Command

Show detailed backup information.

```bash
zkbackup info <backup-id> [flags]

Flags:
  --backup-base-dir string  Backup base directory (default: /backup/zookeeper)
  --format string           Output format: text|json (default: text)
```

### prune - Prune Command

Clean up old backups.

```bash
zkbackup prune [flags]

Flags:
  --backup-base-dir string  Backup base directory (default: /backup/zookeeper)
  --keep-days int           Keep days (default: 7)
  --keep-count int          Keep count (default: 0, no limit)
  --keep-min-count int      Minimum keep count (default: 3)
  --dry-run                 Simulate deletion without actual execution
  --force                   Force deletion without confirmation
  --verbose                 Verbose output
```

## Configuration File

zkbackup supports using a configuration file to simplify command line arguments:

```yaml
# zkbackup.yaml

zookeeper:
  data_dir: /zookeeper/data/version-2
  log_dir: /zookeeper/datalog/version-2
  host: localhost:2181
  timeout: 5

backup:
  base_dir: /backup/zookeeper
  compression: gzip
  compression_level: 6
  auto_verify: true
  auto_repair: true
  concurrent_copies: 4

restore:
  require_confirmation: true
  verify_before_restore: true
  backup_before_restore: true

prune:
  keep_days: 7
  keep_min_count: 3
  require_confirmation: true

logging:
  level: info
  format: text
  output: stdout
```

Configuration file lookup order:
1. Command line argument `--config`
2. Current directory `./zkbackup.yaml`
3. User directory `~/.zkbackup.yaml`
4. System directory `/etc/zkbackup/config.yaml`

## Integration with Other Systems

### Kubernetes CronJob

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: zookeeper-backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: registry.example.com/zkbackup:latest
            command:
            - /usr/local/bin/zkbackup
            - backup
            - --zk-data-dir=/zookeeper/data/version-2
            - --zk-log-dir=/zookeeper/datalog/version-2
            - --output-dir=/backup/zookeeper
            - --zk-host=zk-0.zk-headless:2181
            volumeMounts:
            - name: zk-data
              mountPath: /zookeeper/data
              readOnly: true
            - name: zk-log
              mountPath: /zookeeper/datalog
              readOnly: true
            - name: backup
              mountPath: /backup
          volumes:
          - name: zk-data
            persistentVolumeClaim:
              claimName: data-zk-0
          - name: zk-log
            persistentVolumeClaim:
              claimName: datalog-zk-0
          - name: backup
            persistentVolumeClaim:
              claimName: backup-storage
          restartPolicy: OnFailure
```

## Backup Directory Structure

```
<backup-id>/
├── snapshots/              # Snapshot files
│   ├── snapshot.100000000
│   ├── snapshot.200000000
│   └── snapshot.300000000
├── txnlogs/                # TxnLog files
│   ├── log.100000000
│   ├── log.200000000
│   └── log.300000000
├── metadata/               # Metadata
│   ├── backup_info.json    # Machine-readable metadata
│   ├── MANIFEST.txt        # Human-readable manifest
│   ├── zk_mntr.txt         # ZooKeeper mntr output
│   ├── zk_stat.txt         # ZooKeeper stat output
│   └── zk_conf.txt         # ZooKeeper conf output
└── logs/                   # Logs
    ├── backup.log
    └── verify.log
```

## FAQ

### Q: Does zkbackup support online backup?

A: Yes, zkbackup supports online backup (ZooKeeper does not need to be stopped). However, it is recommended to backup during off-peak hours.

### Q: Why is verification and repair of txnlog necessary?

A: Because txnlog may be actively being written during backup, resulting in incomplete files or checksum errors. Without verification, restore will fail.

### Q: How to verify if a backup is usable?

A: Use the `zkbackup verify --backup-dir /path/to/backup` command to verify.

### Q: Can I backup a single znode?

A: Not supported. zkbackup only performs full backups. For single znode backup, please use a ZooKeeper client.

## Development

### Build

```bash
make build
```

### Test

```bash
make test
```

### Test Coverage

```bash
make test-coverage
```

### Code Formatting

```bash
make fmt
```

## Contributing

Issues and Pull Requests are welcome!

## License

Apache License 2.0

## Documentation

For detailed design documentation, see [ZKBACKUP_DESIGN.md](docs/ZKBACKUP_DESIGN.md)
